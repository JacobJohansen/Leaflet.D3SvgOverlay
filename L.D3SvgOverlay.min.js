/**
 * Copyright 2014 Teralytics AG
 *
 * @author Kirill Zhuravlev <kirill.zhuravlev@teralytics.ch>
 *
 */
if("undefined"==typeof d3)throw"D3 SVG Overlay for Leaflet requires D3 library loaded first";if("undefined"==typeof L)throw"D3 SVG Overlay for Leaflet requires Leaflet library loaded first";d3.select("head").append("style").attr("type","text/css").text("svg.d3-overlay{pointer-events:none;position:absolute;}svg.d3-overlay>g.origin *{pointer-events:visiblePainted;}"),L.D3SvgOverlay=L.Class.extend({includes:L.Mixin.Events,_isDef:function(a){return"undefined"!=typeof a},options:function(options){return this._isDef(options)?(options.zoomAnimate=this._isDef(options.zoomAnimate)?options.zoomAnimate:!0,options.zoomHide=this._isDef(options.zoomHide)?options.zoomHide:!options.zoomAnimate,options.zoomDraw=this._isDef(options.zoomDraw)?options.zoomDraw:!0,options.jsAnimation=options.jsAnimation||!1,this._options=options):this._options},draw:function(){this._drawCallback(this.selection,this.projection,this.map.getZoom())},initialize:function(drawCallback,options){this.options(options||{}),this._drawCallback=drawCallback},updSvg:function(){var pixelSize=this.map.getSize(),pixelBounds=this.map.getPixelBounds(),pixelOrigin=this.map.getPixelOrigin();this._svg.attr("width",3*pixelSize.x).attr("height",3*pixelSize.y).attr("viewBox",[0,0,3*pixelSize.x,3*pixelSize.y].join(" ")).style("left",pixelBounds.min.x-pixelOrigin.x-pixelSize.x+"px").style("top",pixelBounds.min.y-pixelOrigin.y-pixelSize.y+"px"),this._svg.select("g.origin").attr("transform",["translate(",pixelSize.x-(pixelBounds.min.x-pixelOrigin.x),",",pixelSize.y-(pixelBounds.min.y-pixelOrigin.y),")"].join(""))},_zoomCalc:function(evt){var newZoom=this._isDef(evt.zoom)?evt.zoom:this.map._zoom;this._zoomDiff=newZoom-this._zoom,this._scale=Math.pow(2,this._zoomDiff),this._shift=this.map._latLngToNewLayerPoint(this._origin,newZoom,evt.center||this.map._initialCenter)},_zoomStart:function(){!this.translateAnim||this.translateAnim.remove(),!this.scaleAnim||this.scaleAnim.remove()},_zoomAnimate:function(evt){L.Browser.ie||this._options.jsAnimation?(this._gTranslate.transition().duration(250).attr("transform","translate("+this._shift.x+","+this._shift.y+")").ease(d3.ease("cubic-out")),this._gScale.transition().duration(250).attr("transform","scale("+this._scale+")").ease(d3.ease("cubic-out"))):(this.translateAnim=this._svg.append("animateTransform").attr("xlink:href",this._gTranslateXRef).attr("attributeName","transform").attr("attributeType","XML").attr("type","translate").attr("to",this._shift.x+","+this._shift.y).attr("dur","0.25s").attr("calcMode","spline").attr("keyTimes","0; 1").attr("keySplines","0 0 0.25 1").attr("begin","indefinite").attr("fill","freeze"),this.scaleAnim=this._svg.append("animateTransform").attr("xlink:href",this._gScaleXRef).attr("attributeName","transform").attr("attributeType","XML").attr("type","scale").attr("to",this._scale+","+this._scale).attr("dur","0.25s").attr("calcMode","spline").attr("keyTimes","0; 1").attr("keySplines","0 0 0.25 1").attr("begin","indefinite").attr("fill","freeze"),this.translateAnim.node().beginElement(),this.scaleAnim.node().beginElement())},_zoomEnd:function(){this._gTranslate.attr("transform","translate("+this._shift.x+","+this._shift.y+")"),this._gScale.attr("transform","scale("+this._scale+","+this._scale+")"),!this.translateAnim||this.translateAnim.remove(),!this.scaleAnim||this.scaleAnim.remove(),this._options.zoomDraw&&this.draw()},_zoomChange:function(){this._gTranslate.attr("transform","translate("+this._shift.x+","+this._shift.y+")"),this._gScale.attr("transform","scale("+this._scale+","+this._scale+")"),this._options.zoomDraw&&this.draw()},onAdd:function(map){this.map=map,this._zoomAnimated=this._options.zoomAnimate&&map._zoomAnimated;var _layer=this;this._svg=d3.select(map._panes.overlayPane).append("svg").classed({"d3-overlay":!0,"leaflet-zoom-hide":this._options.zoomHide}),this._gOrigin=this._svg.append("g").classed("origin",!0),this.map.on("moveend",this.updSvg,this),this._origin=this.map.layerPointToLatLng([0,0]),this._zoom=this.map.getZoom(),this._shift=L.point(0,0),this._scale=1,_this=this,this.projection={latLngToLayerPoint:function(latLng,zoom){zoom=_this._isDef(zoom)?zoom:_layer._zoom;var projectedPoint=_layer.map.project(L.latLng(latLng),zoom),projectedOrigin=_layer.map.project(_layer._origin,zoom);return projectedPoint._subtract(projectedOrigin)},layerPointToLatLng:function(point,zoom){zoom=_this._isDef(zoom)?zoom:_layer._zoom;var projectedOrigin=_layer.map.project(_layer._origin,zoom);return _layer.map.unproject(point.add(projectedOrigin),zoom)},unitsPerMeter:256*Math.pow(2,_layer._zoom)/40075017,map:_layer.map,layer:_layer},this.projection.latLngToLayerFloatPoint=this.projection.latLngToLayerPoint,this.projection.getZoom=this.map.getZoom.bind(this.map),this.projection.getBounds=this.map.getBounds.bind(this.map);var uniqueId="id"+Math.random().toString(26).slice(2,7);this._gTranslateXRef="#"+uniqueId,this._gTranslate=this._gOrigin.append("g").classed("translate-anim",!0).attr("transform","translate(0,0)").attr("id",uniqueId),uniqueId="id"+Math.random().toString(26).slice(2,7),this._gScaleXRef="#"+uniqueId,this.selection=this._gScale=this._gTranslate.append("g").classed("scale-anim",!0).attr("transform","scale(1,1)").attr("id",uniqueId),this._zoomAnimated?(this.map.on("zoomanim",this._zoomCalc,this),this.map.on("zoomstart",this._zoomStart,this),this.map.on("zoomanim",this._zoomAnimate,this),this.map.on("zoomend",this._zoomEnd,this)):(this.map.on("viewreset",this._zoomCalc,this),this.map.on("viewreset",this._zoomChange,this)),this.updSvg(),this.draw()},onRemove:function(map){this._svg.remove(),this.map.off(this._options.updateOn,this.draw,this),this.map.off("moveend",this.updSvg,this),this._zoomAnimated?(this.map.off("zoomanim",this._zoomCalc,this),this.map.off("zoomstart",this._zoomStart,this),this.map.off("zoomanim",this._zoomAnimate,this),this.map.off("zoomend",this._zoomEnd,this)):(this.map.off("viewreset",this._zoomCalc,this),this.map.off("viewreset",this._zoomChange,this))},addTo:function(map){return map.addLayer(this),this}}),L.D3SvgOverlay.version="2.0",L.d3SvgOverlay=function(drawCallback,options){return new L.D3SvgOverlay(drawCallback,options)};